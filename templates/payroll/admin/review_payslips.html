{% extends 'payroll/admin/payroll_admin_base.html' %}
{% block title %}Review Payslips{% endblock %}

{% block content %}
<main class="content-wrap">
  <header class="content-head">
    <h1><b>Review & Approve Payslips</b></h1>
  </header>

  <div class="table-container">
    <!-- Approve All Button -->
    <div style="margin-bottom: 20px; text-align: left;">
      <form method="POST">
        <input type="hidden" name="action" value="approve_all">
        <button type="submit"
                class="btn btn-success"
                id="approveAllBtn"
                style="background-color: #198754; color: white; border: none; padding: 8px 14px; border-radius: 6px;">
          Approve All
        </button>
      </form>
    </div>

    <table class="responsive-table">
      <caption><b>Payslip Review Table</b></caption>
      <thead>
        <tr>
          <th>Payslip No.</th>
          <th>Employee</th>
          <th>Period</th>
          <th>Net Pay</th>
          <th>Status</th>
          <th>Decision</th>
          <th>Submit</th>
        </tr>
      </thead>
      <tbody>
        {% for p in payslips %}
        {% if p.status == "Generated" %}
        <tr>
          <form method="POST">
            <input type="hidden" name="payslip_id" value="{{ p.id }}">

            <td>{{ p.payslip_number }}</td>
            <td>{{ p.employee.first_name }} {{ p.employee.last_name }}</td>
            <td>{{ p.pay_period_start }} → {{ p.pay_period_end }}</td>
            <td><b>₱ {{ "%.2f"|format(p.net_pay) }}</b></td>
            <td>
              <span class="badge"
                    style="background-color:#e2e3e5; color:#6c757d; padding:4px 8px; border-radius:6px;">
                {{ p.status }}
              </span>
            </td>

            <td>
              <select name="decision" class="decision-select" style="padding:6px; border-radius:6px;">
                <option value="approve">Approve</option>
                <option value="reject">Reject</option>
              </select>
            </td>

            <td>
              <button type="submit"
                      class="btn btn-primary"
                      style="background-color:#3d6ef7; color:white; border:none; padding:6px 12px; border-radius:6px;">
                Submit
              </button>
            </td>
          </form>
        </tr>
        {% else %}
        <tr>
          <td>{{ p.payslip_number }}</td>
          <td>{{ p.employee.first_name }} {{ p.employee.last_name }}</td>
          <td>{{ p.pay_period_start }} → {{ p.pay_period_end }}</td>
          <td><b>₱ {{ "%.2f"|format(p.net_pay) }}</b></td>
          <td>
            {% if p.status == "Approved" %}
            <span class="badge" style="background-color:#d1e7dd; color:#198754; padding:4px 8px; border-radius:6px;">{{ p.status }}</span>
            {% elif p.status == "Rejected" %}
            <span class="badge" style="background-color:#f8d7da; color:#dc3545; padding:4px 8px; border-radius:6px;">{{ p.status }}</span>
            {% else %}
            <span class="badge" style="background-color:#f8f9fa; color:gray; padding:4px 8px; border-radius:6px;">{{ p.status }}</span>
            {% endif %}
          </td>
          <td colspan="2"><i class="text-muted">Already {{ p.status.lower() }}</i></td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</main>

<!-- SweetAlert & JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.getElementById("approveAllBtn").addEventListener("click", function(e) {
  e.preventDefault();
  Swal.fire({
    title: 'Approve All Payslips?',
    text: 'This will approve all pending payslips.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#198754',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Yes, approve all'
  }).then((result) => {
    if (result.isConfirmed) {
      this.closest('form').submit();
    }
  });
});
</script>
{% endblock %}
