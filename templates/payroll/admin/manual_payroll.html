{% extends 'payroll/admin/payroll_admin_base.html' %}
{% block content %}
<h2>Manual Payroll Processing</h2>

<div class="searching" style="margin-bottom: 20px;">
    <form id="payrollPeriodForm">
        <div class="fields">
            <div class="input-field">
                <select id="pay_period_id">
                    <option value="">-- Select Period --</option>
                    {% for period in payroll_periods %}
                        <option value="{{ period.id }}">{{ period.start_date }} to {{ period.end_date }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-field" style="align-self: flex-end;">
                <button type="button" class="btn-action" onclick="calculateWorkingHours()">Calculate Hours</button>
            </div>
        </div>
    </form>
</div>

<div class="table-wrapper">
    <div class="table-container" style="overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th>Employee</th>
                    <th>Hourly Rate</th>
                    <th>Allowance</th>
                    <th>Working Hours</th>
                    <th>SSS</th>
                    <th>PhilHealth</th>
                    <th>Pag-IBIG</th>
                    <th>Tax</th>
                    <th>Other Deductions</th>
                    <th>Net Pay</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees %}
                <tr id="row-{{ emp.id }}" data-existing-periods="{{ emp.existing_payrolls|join(',') }}">
                    <td>{{ emp.full_name }}</td>
                    <td><input type="text" name="basic_salary" value="{{ emp.basic_salary }}" class="table-input numeric-input" readonly/></td>
                    <td><input type="text" name="allowance" value="{{ emp.allowance }}" class="table-input numeric-input"/></td>
                    <td class="working-hours">0</td>
                    <td><input type="text" name="sss" value="{{ emp.sss }}" class="table-input numeric-input"/></td>
                    <td><input type="text" name="philhealth" value="{{ emp.philhealth }}" class="table-input numeric-input"/></td>
                    <td><input type="text" name="pagibig" value="{{ emp.pagibig }}" class="table-input numeric-input"/></td>
                    <td><input type="text" name="tax" value="0" class="table-input numeric-input"/></td>
                    <td><input type="text" name="other" value="0" class="table-input numeric-input"/></td>
                    <td class="net_pay">₱ 0.00</td>
                    <td>
                        <button class="btn-action" onclick="processPayroll({{ emp.id }})">Process</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const workingHoursUrl = "{{ url_for('payroll_admin.get_working_hours') }}";

function parseInput(value) { return parseFloat(value.replace(/,/g, '')) || 0; }

document.querySelectorAll('.numeric-input').forEach(input => {
    input.addEventListener('input', () => { input.value = input.value.replace(/[^0-9.]/g, ''); });
});

function calculateWorkingHours() {
    const periodSelect = document.getElementById('pay_period_id');
    const periodText = periodSelect.selectedOptions[0]?.text;
    if (!periodText) {
        Swal.fire({ icon:'warning', title:'Select a payroll period!' });
        return;
    }
    const [startDate, endDate] = periodText.split(' to ');

    document.querySelectorAll('tbody tr').forEach(row => {
        const empId = row.id.replace('row-', '');
        fetch(`${workingHoursUrl}?employee_id=${empId}&start_date=${startDate}&end_date=${endDate}`)
        .then(res => res.json())
        .then(data => {
            const hours = data.working_hours || 0;
            row.querySelector('.working-hours').innerText = hours.toFixed(2);
            row.dataset.workingHours = hours;
            updateNetPay(row);
        });
    });
}

// Update net pay for each row
function updateNetPay(row) {
    const basic = parseInput(row.querySelector('input[name="basic_salary"]').value);
    const allowance = parseInput(row.querySelector('input[name="allowance"]').value);
    const sss = parseInput(row.querySelector('input[name="sss"]').value);
    const philhealth = parseInput(row.querySelector('input[name="philhealth"]').value);
    const pagibig = parseInput(row.querySelector('input[name="pagibig"]').value);
    const tax = parseInput(row.querySelector('input[name="tax"]').value);
    const other = parseInput(row.querySelector('input[name="other"]').value);
    const hours = parseFloat(row.dataset.workingHours || 0);

    const net = (basic * hours) + allowance - sss - philhealth - pagibig - tax - other;
    
    row.querySelector('.net_pay').innerText = `₱ ${net.toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
}

// Update net pay on input change
document.querySelectorAll('.table-input').forEach(input => {
    input.addEventListener('input', e => updateNetPay(e.target.closest('tr')));
});

// Process payroll
function processPayroll(empId) {
    const row = document.getElementById(`row-${empId}`);
    const periodId = document.getElementById('pay_period_id').value;
    const processBtn = row.querySelector('.btn-action');

    if (!periodId) {
        Swal.fire({ icon:'warning', title:'Select a payroll period!' });
        return;
    }
    if (processBtn.disabled) return;

    const data = {
        employee_id: empId,
        pay_period_id: periodId,
        basic_salary: parseInput(row.querySelector('input[name="basic_salary"]').value),
        allowance: parseInput(row.querySelector('input[name="allowance"]').value),
        sss: parseInput(row.querySelector('input[name="sss"]').value),
        philhealth: parseInput(row.querySelector('input[name="philhealth"]').value),
        pagibig: parseInput(row.querySelector('input[name="pagibig"]').value),
        tax: parseInput(row.querySelector('input[name="tax"]').value),
        other: parseInput(row.querySelector('input[name="other"]').value),
        working_hours: parseFloat(row.dataset.workingHours || 0)
    };

    fetch("", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: new URLSearchParams(data)
    })
    .then(res => res.json())
    .then(res => {
        if(res.status === "success") {
            row.querySelector('.net_pay').innerText = `₱ ${res.net_pay.toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
            processBtn.disabled = true;
            processBtn.style.backgroundColor = '#888';
            processBtn.style.cursor = 'not-allowed';
            Swal.fire({
                icon: 'success',
                title: 'Payroll Processed',
                text: `${row.querySelector('td').innerText} payroll has been saved successfully!`,
                timer: 2500,
                showConfirmButton: false
            });
        } else {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to process payroll.' });
        }
    })
    .catch(err => {
        console.error(err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Unable to process payroll. Try again later.' });
    });
}

// Disable process button if payroll already exists for selected period
document.getElementById('pay_period_id').addEventListener('change', () => {
    const selectedPeriodId = parseInt(document.getElementById('pay_period_id').value) || 0;

    document.querySelectorAll('tbody tr').forEach(row => {
        const btn = row.querySelector('.btn-action');
        const existingPeriods = row.dataset.existingPeriods.split(',').map(id => parseInt(id));

        if (existingPeriods.includes(selectedPeriodId)) {
            btn.disabled = true;
            btn.style.backgroundColor = '#888';
            btn.style.cursor = 'not-allowed';
        } else {
            btn.disabled = false;
            btn.style.backgroundColor = '#4070f4';
            btn.style.cursor = 'pointer';
        }
    });
});
</script>

<style>
.table-container { min-width:1200px; background:#fff; border-radius:12px; padding:20px; margin-top:20px; box-shadow:0 5px 20px rgba(0,0,0,0.2); overflow-x:auto;}
.table-container table {width:100%; border-collapse:collapse;}
.table-container th, .table-container td {white-space:nowrap; text-align:center; padding:12px;}
.table-input {width:120px; padding:6px 10px; border-radius:6px; border:1px solid #aaa; text-align:center;}
.btn-action {background-color:#4070f4;color:#fff;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;}
.btn-action:hover{background-color:#265df2;}
.btn-action:disabled {background:#888; cursor:not-allowed;}
</style>
{% endblock %}
