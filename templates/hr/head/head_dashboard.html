{% extends 'hr/head/head_base.html' %}
{% block title %}Department Head - Dashboard{% endblock %}
{% block content %}

{% if not_assigned %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
Swal.fire({
    icon: 'info',
    title: 'Access Denied',
    text: 'You are not assigned as a department head yet. Please wait for the admins to assign you.',
    confirmButtonText: 'OK'
}).then((result) => {
    if (result.isConfirmed) {
        window.location.href = "{{ url_for('hr_auth.logout') }}";
    }
});
</script>
{% endif %}

<main class="content-wrap">
  <header class="content-head">
    <h1><b>{{ current_user.department.name }} Department Head Dashboard</b></h1>
  </header>

  <div class="content">
    <section class="info-boxes">
    
      <!-- Total Employees -->
      <div class="info-box">
        <div class="box-icon">
          <span class="material-symbols-outlined" style="font-size: 50px; color:#4a5568; font-weight: 400;">
            group
          </span>
        </div>
        <div class="box-content">
          <span class="big">{{ total_employees }}</span>
          Employees in <br> {{ current_user.department.name }}
        </div>
      </div>

      <!-- Recent Leave Requests -->
      <div class="info-box">
        <div class="box-icon">
         <span class="material-symbols-outlined" style="font-size: 50px; color:#4a5568; font-weight: 400;">
            assignment_add
          </span>
        </div>
        <div class="box-content">
          <span class="big">{{ recent_leaves|length }}</span>
          Recent Leave <br> Requests
        </div>
      </div>

      <!-- Present -->
      <div class="info-box">
        <div class="box-icon">
           <span class="material-symbols-outlined" style="font-size: 50px; color:#4a5568; font-weight: 400;">
            check_circle
          </span>
        </div>
        <div class="box-content">
          <span class="big">{{ attendance_summary.total_present }}</span>
          Present (This Month)
        </div>
      </div>

      <!-- Absent -->
      <div class="info-box">
        <div class="box-icon">
           <span class="material-symbols-outlined" style="font-size: 50px; color:#4a5568; font-weight: 400;">
            cancel
          </span>
        </div>
        <div class="box-content">
          <span class="big">{{ attendance_summary.total_absent }}</span>
          Absent (This Month)
        </div>
      </div>

      <!-- Late -->
      <div class="info-box">
        <div class="box-icon">
            <span class="material-symbols-outlined" style="font-size: 50px; color:#4a5568; font-weight: 400;">
              schedule
            </span>
        </div>
        <div class="box-content">
          <span class="big">{{ attendance_summary.total_late }}</span>
          Late (This Month)
        </div>
      </div>

    </section>
  </div>

  <!-- Chart Section -->
  <section class="chart-section">
    <div class="chart-card">
      <canvas id="monthlyAttendanceChart"></canvas>
    </div>
  </section>

  <style>
    .chart-section {
      margin-top: 40px;
    }
    .chart-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }
    .chart-card canvas {
      width: 100% !important;
      height: 400px !important;
    }
  </style>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const monthlyDates = {{ attendance_summary.dates | tojson }};
  const monthlyPresentCounts = {{ attendance_summary.present_counts | tojson }};
  const monthlyAbsentCounts = {{ attendance_summary.absent_counts | tojson }};
  const monthlyLateCounts = {{ attendance_summary.late_counts | tojson }};

  const ctx = document.getElementById('monthlyAttendanceChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: monthlyDates,
      datasets: [
        {
          label: 'Present',
          data: monthlyPresentCounts,
          backgroundColor: 'rgba(75, 192, 192, 0.7)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        },
        {
          label: 'Absent',
          data: monthlyAbsentCounts,
          backgroundColor: 'rgba(255, 99, 132, 0.7)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 1
        },
        {
          label: 'Late',
          data: monthlyLateCounts,
          backgroundColor: 'rgba(255, 206, 86, 0.7)',
          borderColor: 'rgba(255, 206, 86, 1)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Monthly Attendance Overview',
          font: { size: 18 }
        },
        legend: {
          position: 'bottom'
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Date'
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Count'
          }
        }
      }
    }
  });
});
</script>

{% endblock %}
