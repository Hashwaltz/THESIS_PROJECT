{% extends 'hr/head/head_base.html' %}
{% block title %}Department Head - Attendance Records{% endblock %}

{% block content %}
<main class="content-wrap">
  <header class="content-head">
      <h1><b>{{ department.name if department else 'Department' }} Attendance Records</b></h1>
  </header>
  <div class="search-box">
    <form method="get" class="filter-form" id="filterForm">
      <div class="fields">
        <!-- Date Filter -->
        <div class="input-field">
          <label for="date">Date</label>
          <input type="date" id="date" name="date" value="{{ date_filter }}">
        </div>

        <!-- Employee Filter -->
        <div class="input-field">
          <label for="employee">Employee</label>
          <select id="employee" name="employee" onchange="document.getElementById('filterForm').submit()">
            <option value="">All Employees</option>
            {% for emp in employees.items %}
            <option value="{{ emp.id }}" {% if emp.id == employee_filter %}selected{% endif %}>
              {{ emp.get_full_name() }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- Filter Button (for Date only) -->
        <div class="input-field">
          <label>&nbsp;</label>
          <button type="submit" class="submit">
            <span class="material-symbols-outlined">
            database_search
            </span>
            Filter
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- ============================
       ATTENDANCE TABLE
  ============================= -->
  <div class="table-container">
    <table class="responsive-table">
      <caption><b>Attendance List</b></caption>
      <thead>
        <tr>
          <th>Employee</th>
          <th>Date</th>
          <th>Time In</th>
          <th>Time Out</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for att in attendances.items %}
        <tr>
          <td data-label="Employee">{{ att.employee.get_full_name() }}</td>
          <td data-label="Date">{{ att.date.strftime('%Y-%m-%d') }}</td>
          <td data-label="Time In">{{ att.time_in.strftime('%H:%M') if att.time_in else '---' }}</td>
          <td data-label="Time Out">{{ att.time_out.strftime('%H:%M') if att.time_out else '---' }}</td>
          <td data-label="Status" style="color:
              {% if att.status == 'Present' %}green
              {% elif att.status == 'Late' %}orange
              {% else %}red{% endif %};">
            {{ att.status }}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5">No attendance records found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ============================
       ATTENDANCE PAGINATION
  ============================= -->
  {% if attendances.pages > 1 %}
  <div class="pagination">
    {% if attendances.has_prev %}
    <a href="{{ url_for('dept_head.attendance', page=attendances.prev_num, date=date_filter, employee=employee_filter) }}">Previous</a>
    {% endif %}

    Page {{ attendances.page }} of {{ attendances.pages }}

    {% if attendances.has_next %}
    <a href="{{ url_for('dept_head.attendance', page=attendances.next_num, date=date_filter, employee=employee_filter) }}">Next</a>
    {% endif %}
  </div>
  {% endif %}

  <!-- ============================
       ABSENTEES SECTION
  ============================= -->
  {% if absentees %}
  <section class="person-boxes">
    <h2><b>Absent Employees</b></h2>
    {% for emp in absentees %}
    <div class="person-box">
      <div class="box-avatar">
        <img
          src="{{ emp.photo if emp.photo else url_for('static', filename='images/user/user_logo.webp') }}"
          alt="{{ emp.get_full_name() }}"
        />
      </div>
      <div class="box-bio">
        <h3 class="bio-name">{{ emp.get_full_name() }}</h3>
        <p class="bio-position">
          {{ emp.position.name if emp.position else "No Position" }}
        </p>
        <p class="bio-status" style="color:red;">Absent</p>
      </div>
    </div>
    {% endfor %}
  </section>
  {% endif %}

  <!-- ============================
       LATE ARRIVALS SECTION
  ============================= -->
  {% if late_arrivals %}
  <section class="person-boxes">
    <h2><b>Late Arrivals</b></h2>
    {% for l in late_arrivals %}
    <div class="person-box">
      <div class="box-avatar">
        <img
          src="{{ l.employee.photo if l.employee.photo else url_for('static', filename='images/user/user_logo.webp') }}"
          alt="{{ l.employee.get_full_name() }}"
        />
      </div>
      <div class="box-bio">
        <h3 class="bio-name">{{ l.employee.get_full_name() }}</h3>
        <p class="bio-position">
          {{ l.employee.position.name if l.employee.position else "No Position" }}
        </p>
        <p class="bio-status" style="color:orange;">
          Late - {{ l.time_in.strftime('%H:%M') }}
        </p>
      </div>
    </div>
    {% endfor %}
  </section>
  {% endif %}
</main>

<!-- ============================
     AUTO-SUBMIT SCRIPT
============================= -->
<script>
  // Automatically submit form when employee select changes
  document.getElementById("employee").addEventListener("change", function() {
    document.getElementById("filterForm").submit();
  });
</script>

{% endblock %}
