{% extends 'hr/officer/officer_base.html' %}
{% block title %}Department Head - Leave Requests{% endblock %}

{% block content %}
<main class="content-wrap">
  <header class="content-head">
    <h1>Leave Requests</h1>
  </header>

  <!-- Filter Form -->
  <div class="search-box">
    <form method="get" class="filter-form">
      <div class="fields">
        <div class="input-field">
          <label>Status</label>
          <select name="status" onchange="this.form.submit()">
            <option value="">All</option>
            <option value="Pending" {% if status_filter == "Pending" %}selected{% endif %}>Pending</option>
            <option value="Approved" {% if status_filter == "Approved" %}selected{% endif %}>Approved</option>
            <option value="Rejected" {% if status_filter == "Rejected" %}selected{% endif %}>Rejected</option>
          </select>
        </div>
      </div>
    </form>
  </div>

  <!-- Leave Table -->
  <div class="table-container centered-container">
    <table class="responsive-table">
      <caption><b>Leave List</b></caption>
      <thead>
        <tr>
          <th>Employee</th>
          <th>Leave Type</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Reason</th>
          <th>Status</th>
          <th>Requested At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for leave in leaves.items %}
        <tr>
          <td>{{ leave.employee.get_full_name() }}</td>
          <td>{{ leave.leave_type.name }}</td>
          <td>{{ leave.start_date.strftime('%Y-%m-%d') }}</td>
          <td>{{ leave.end_date.strftime('%Y-%m-%d') }}</td>
          <td>{{ leave.reason }}</td>
          <td>
            <span 
              {% if leave.status == 'Approved' %} style="color:green;font-weight:bold;" 
              {% elif leave.status == 'Pending' %} style="color:orange;font-weight:bold;" 
              {% elif leave.status == 'Rejected' %} style="color:red;font-weight:bold;" 
              {% endif %}
            >
              {{ leave.status }}
            </span>
          </td>
          <td>{{ leave.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>
            {% if leave.status == 'Pending' %}
            <form method="POST" action="{{ url_for('dept_head.approve_leave', leave_id=leave.id) }}" class="action-form" style="display:inline-block;">
              <input type="hidden" name="comments" value="">
              <button type="button" class="btn-approve" style="background-color:green;color:white;border:none;border-radius:5px;padding:5px 10px;">Approve</button>
              <button type="button" class="btn-reject" style="background-color:red;color:white;border:none;border-radius:5px;padding:5px 10px;">Reject</button>
            </form>
            {% else %}
            -
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8">No leave requests found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination">
      {% if leaves.has_prev %}
        <a href="{{ url_for('dept_head.leaves', page=leaves.prev_num, status=status_filter) }}">Previous</a>
      {% endif %}
      Page {{ leaves.page }} of {{ leaves.pages }}
      {% if leaves.has_next %}
        <a href="{{ url_for('dept_head.leaves', page=leaves.next_num, status=status_filter) }}">Next</a>
      {% endif %}
    </div>
  </div>
</main>

<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.action-form');

    forms.forEach(form => {
        const approveBtn = form.querySelector('.btn-approve');
        const rejectBtn = form.querySelector('.btn-reject');

        approveBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Are you sure you want to approve this leave?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, approve it!',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d'
            }).then(result => {
                if(result.isConfirmed){
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'status';
                    input.value = 'Approved';
                    form.appendChild(input);
                    form.submit();
                }
            });
        });

        rejectBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Reject leave request',
                input: 'text',
                inputLabel: 'Reason / Comment (optional)',
                inputPlaceholder: 'Enter comment',
                showCancelButton: true,
                confirmButtonText: 'Reject',
                icon: 'warning',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            }).then(result => {
                if(result.isConfirmed){
                    const inputStatus = document.createElement('input');
                    inputStatus.type = 'hidden';
                    inputStatus.name = 'status';
                    inputStatus.value = 'Rejected';
                    form.appendChild(inputStatus);

                    const inputComments = document.createElement('input');
                    inputComments.type = 'hidden';
                    inputComments.name = 'comments';
                    inputComments.value = result.value || '';
                    form.appendChild(inputComments);

                    form.submit();
                }
            });
        });
    });
});
</script>
{% endblock %}
