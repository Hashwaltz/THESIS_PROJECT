{% extends 'hr/admin/admin_base.html' %}
{% block title %}Edit User{% endblock %}

{% block content %}
<main class="content-wrap">
  <header class="content-head">
    <h1><b>Edit Account Details</b></h1>
  </header>

  <div class="edit-container">
    <form id="editUserForm" method="POST" action="{{ url_for('hr_admin.edit_user', user_id=user.id) }}">
      <div class="form first">
        <div class="details personal">
          <div class="fields">

            <div class="input-field">
              <label>Email</label>
              <input type="email" name="email" value="{{ user.email }}" readonly />
            </div>

            <div class="input-field">
              <label>First Name</label>
              <input type="text" name="first_name" value="{{ user.first_name }}" readonly />
            </div>

            <div class="input-field">
              <label>Last Name</label>
              <input type="text" name="last_name" value="{{ user.last_name }}" readonly />
            </div>

            <div class="input-field">
              <label>Role</label>
              <select name="role" required>
                <option disabled selected>Select Role</option>
                <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                <option value="officer" {% if user.role == 'officer' %}selected{% endif %}>Officer</option>
                <option value="dept_head" {% if user.role == 'dept_head' %}selected{% endif %}>Department Head</option>
                <option value="employee" {% if user.role == 'employee' %}selected{% endif %}>Employee</option>
                <option value="staff" {% if user.role == 'staff' %}selected{% endif %}>Payroll Staff</option>
              </select>
            </div>

            <div class="input-field">
              <label>Status</label>
              <select name="status" required>
                <option disabled selected>Select Status</option>
                <option value="1" {% if user.active %}selected{% endif %}>Active</option>
                <option value="0" {% if not user.active %}selected{% endif %}>Inactive</option>
              </select>
            </div>

          </div>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button type="submit" style="color: #fff;" class="printing">
            <span class="material-symbols-outlined">update</span>
            Update
          </button>
          <a href="{{ url_for('hr_admin.view_users') }}" style="background: #FF6347;" class="printing">
            <span class="material-symbols-outlined">cancel</span>
            Cancel
          </a>
        </div>
      </div>
    </form>
  </div>
</main>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.getElementById("editUserForm").addEventListener("submit", function(e) {
  e.preventDefault();

  Swal.fire({
    title: 'Are you sure?',
    text: "Do you want to update this user?",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Yes, update!'
  }).then((result) => {
    if (result.isConfirmed) {
      const form = e.target;
      const formData = new FormData(form);

      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(async res => {
        // try parse JSON safely
        let data;
        try {
          data = await res.json();
        } catch (err) {
          throw new Error('Invalid JSON response from server.');
        }

        // Accept both shapes:
        // - { status: "success", message: "..." }
        // - { success: true }
        const isSuccess = (data && (data.status === "success" || data.success === true));
        const message = (data && (data.message || data.msg)) || (isSuccess ? "Updated successfully." : "An error occurred.");

        if (isSuccess) {
          Swal.fire({
            icon: 'success',
            title: 'Updated!',
            text: message,
            timer: 1500,
            showConfirmButton: false
          }).then(() => {
            window.location.href = "{{ url_for('hr_admin.view_users') }}";
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: message
          });
        }
      })
      .catch(error => {
        console.error('Update user error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: 'Something went wrong. Please try again.'
        });
      });
    }
  });
});
</script>
{% endblock %}
